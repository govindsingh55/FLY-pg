version: '3.8'

x-defaults: &defaults
  env_file:
    - .env

services:
  # Development service with hot-reload
  web-dev:
    image: node:${NODE_VERSION:-22.12.0}-alpine
    working_dir: /home/node/app
    user: node
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: development
    volumes:
      - .:/home/node/app
      - node_modules:/home/node/app/node_modules
    command: >
      sh -c "npm install && npm run dev"
    restart: unless-stopped
    <<: *defaults

  # Production service using multi-stage Dockerfile
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_VERSION: ${NODE_VERSION:-22.12.0}
    image: fly-pg-web:${TAG:-latest}
    environment:
      NODE_ENV: production
      PORT: 3000
    ports:
      - '3000:3000'
    restart: unless-stopped
    <<: *defaults

volumes:
  node_modules:
